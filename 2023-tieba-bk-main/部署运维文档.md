# 百度贴吧项目部署运维文档

## 1. 项目部署概述

### 1.1 部署架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端服务器     │    │   后端服务器     │    │   数据库集群     │
│   (Nginx)       │    │   (Django)      │    │   (MySQL)       │
│                 │    │                 │    │                 │
│ 静态文件服务     │◄──►│  API接口服务    │◄──►│  主从复制       │
│ 负载均衡         │    │  Celery任务队列  │    │  读写分离       │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                        │                        │
         ▼                        ▼                        ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   CDN网络        │    │   Redis缓存      │    │   Elasticsearch  │
│   图片加速       │    │   会话存储       │    │   全文搜索       │
│   静态资源       │    │   消息队列       │    │   日志分析       │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 1.2 部署环境要求

#### 1.2.1 硬件要求
| 组件 | 最低配置 | 推荐配置 | 生产环境配置 |
|------|----------|----------|--------------|
| Web服务器 | 2核4G | 4核8G | 8核16G |
| 数据库服务器 | 4核8G | 8核16G | 16核32G |
| 缓存服务器 | 2核4G | 4核8G | 8核16G |
| 搜索服务器 | 4核8G | 8核16G | 16核32G |

#### 1.2.2 软件要求
| 组件 | 版本要求 | 说明 |
|------|----------|------|
| Python | 3.8+ | 后端开发语言 |
| Django | 4.2+ | Web框架 |
| MySQL | 8.0+ | 数据库 |
| Redis | 6.0+ | 缓存和消息队列 |
| Elasticsearch | 7.0+ | 搜索引擎 |
| Nginx | 1.18+ | Web服务器和负载均衡 |
| Docker | 20.0+ | 容器化部署 |

## 2. 开发环境部署

### 2.1 环境准备

#### 2.1.1 安装Python环境
```bash
# 使用pyenv管理Python版本
pyenv install 3.9.18
pyenv virtualenv 3.9.18 tieba-env
pyenv activate tieba-env
```

#### 2.1.2 安装项目依赖
```bash
# 创建项目目录
mkdir -p /opt/tieba
cd /opt/tieba

# 克隆代码
git clone https://github.com/your-org/tieba-project.git
cd tieba-project

# 安装依赖
pip install -r requirements.txt
```

### 2.2 数据库配置

#### 2.2.1 MySQL配置
```sql
-- 创建数据库和用户
CREATE DATABASE tieba_dev CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'tieba_user'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON tieba_dev.* TO 'tieba_user'@'localhost';
FLUSH PRIVILEGES;
```

#### 2.2.2 Redis配置
```bash
# 安装Redis
sudo apt-get install redis-server

# 配置Redis
sudo vim /etc/redis/redis.conf
# 修改以下配置
bind 127.0.0.1
port 6379
requirepass your_redis_password
```

### 2.3 项目配置

#### 2.3.1 环境变量配置
```bash
# 创建.env文件
cat > .env << EOF
# Django配置
DEBUG=True
SECRET_KEY=your-secret-key-here
ALLOWED_HOSTS=localhost,127.0.0.1

# 数据库配置
DB_NAME=tieba_dev
DB_USER=tieba_user
DB_PASSWORD=your_password
DB_HOST=localhost
DB_PORT=3306

# Redis配置
REDIS_URL=redis://:your_redis_password@localhost:6379/0

# 文件存储
MEDIA_ROOT=/opt/tieba/media
STATIC_ROOT=/opt/tieba/static

# 第三方服务
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USER=your-email@gmail.com
EMAIL_PASSWORD=your-email-password

# 短信服务
SMS_ACCESS_KEY=your-sms-key
SMS_ACCESS_SECRET=your-sms-secret
EOF
```

#### 2.3.2 数据库迁移
```bash
# 创建数据库表
python manage.py makemigrations
python manage.py migrate

# 创建超级用户
python manage.py createsuperuser

# 导入初始数据
python manage.py loaddata initial_data.json
```

### 2.4 启动开发服务器

#### 2.4.1 启动Django开发服务器
```bash
# 启动开发服务器
python manage.py runserver 0.0.0.0:8000

# 启动Celery worker
celery -A tieba worker -l info

# 启动Celery beat
celery -A tieba beat -l info
```

#### 2.4.2 启动前端开发服务器
```bash
# 进入前端目录
cd frontend

# 安装依赖
npm install

# 启动开发服务器
npm run dev
```

## 3. 生产环境部署

### 3.1 Docker容器化部署

#### 3.1.1 Dockerfile配置
```dockerfile
# Dockerfile
FROM python:3.9-slim

# 设置工作目录
WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    gcc \
    default-libmysqlclient-dev \
    pkg-config \
    && rm -rf /var/lib/apt/lists/*

# 复制依赖文件
COPY requirements.txt .

# 安装Python依赖
RUN pip install --no-cache-dir -r requirements.txt

# 复制项目代码
COPY . .

# 收集静态文件
RUN python manage.py collectstatic --noinput

# 暴露端口
EXPOSE 8000

# 启动命令
CMD ["gunicorn", "tieba.wsgi:application", "--bind", "0.0.0.0:8000", "--workers", "4"]
```

#### 3.1.2 docker-compose.yml配置
```yaml
# docker-compose.yml
version: '3.8'

services:
  # MySQL数据库
  db:
    image: mysql:8.0
    container_name: tieba_mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: tieba_prod
      MYSQL_USER: tieba_user
      MYSQL_PASSWORD: ${DB_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./config/mysql/my.cnf:/etc/mysql/conf.d/my.cnf
    ports:
      - "3306:3306"
    networks:
      - tieba_network

  # Redis缓存
  redis:
    image: redis:6.2-alpine
    container_name: tieba_redis
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    networks:
      - tieba_network

  # Elasticsearch搜索
  elasticsearch:
    image: elasticsearch:7.17.0
    container_name: tieba_es
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    volumes:
      - es_data:/usr/share/elasticsearch/data
    ports:
      - "9200:9200"
    networks:
      - tieba_network

  # Django应用
  web:
    build: .
    container_name: tieba_web
    environment:
      - DEBUG=False
      - SECRET_KEY=${SECRET_KEY}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS}
      - DB_NAME=tieba_prod
      - DB_USER=tieba_user
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_HOST=db
      - DB_PORT=3306
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
      - ELASTICSEARCH_URL=http://elasticsearch:9200
    volumes:
      - media_data:/app/media
      - static_data:/app/static
    ports:
      - "8000:8000"
    depends_on:
      - db
      - redis
      - elasticsearch
    networks:
      - tieba_network

  # Celery Worker
  celery:
    build: .
    container_name: tieba_celery
    command: celery -A tieba worker -l info
    environment:
      - DEBUG=False
      - SECRET_KEY=${SECRET_KEY}
      - DB_NAME=tieba_prod
      - DB_USER=tieba_user
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_HOST=db
      - DB_PORT=3306
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
    volumes:
      - media_data:/app/media
    depends_on:
      - db
      - redis
      - web
    networks:
      - tieba_network

  # Celery Beat
  celery_beat:
    build: .
    container_name: tieba_celery_beat
    command: celery -A tieba beat -l info
    environment:
      - DEBUG=False
      - SECRET_KEY=${SECRET_KEY}
      - DB_NAME=tieba_prod
      - DB_USER=tieba_user
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_HOST=db
      - DB_PORT=3306
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
    volumes:
      - media_data:/app/media
    depends_on:
      - db
      - redis
      - web
    networks:
      - tieba_network

  # Nginx反向代理
  nginx:
    image: nginx:1.21-alpine
    container_name: tieba_nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./config/nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./config/nginx/conf.d:/etc/nginx/conf.d
      - static_data:/var/www/static
      - media_data:/var/www/media
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - web
    networks:
      - tieba_network

volumes:
  mysql_data:
  redis_data:
  es_data:
  media_data:
  static_data:

networks:
  tieba_network:
    driver: bridge
```

### 3.2 Nginx配置

#### 3.2.1 nginx.conf配置
```nginx
# nginx.conf
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
    use epoll;
    multi_accept on;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # 日志格式
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    # 基础配置
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # 上传文件大小限制
    client_max_body_size 100m;

    include /etc/nginx/conf.d/*.conf;
}
```

#### 3.2.2 站点配置
```nginx
# conf.d/tieba.conf
upstream django {
    server web:8000;
}

server {
    listen 80;
    server_name tieba.example.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name tieba.example.com;

    # SSL证书
    ssl_certificate /etc/nginx/ssl/tieba.example.com.crt;
    ssl_certificate_key /etc/nginx/ssl/tieba.example.com.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    # 静态文件服务
    location /static/ {
        alias /var/www/static/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    location /media/ {
        alias /var/www/media/;
        expires 30d;
        add_header Cache-Control "public";
    }

    # API接口
    location /api/ {
        proxy_pass http://django;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # WebSocket支持
    location /ws/ {
        proxy_pass http://django;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 前端路由
    location / {
        proxy_pass http://django;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 3.3 部署脚本

#### 3.3.1 自动化部署脚本
```bash
#!/bin/bash
# deploy.sh

set -e

# 环境变量
ENV=${1:-production}
COMPOSE_FILE="docker-compose.${ENV}.yml"

# 颜色输出
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# 日志函数
log() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1"
}

error() {
    echo -e "${RED}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1"
    exit 1
}

# 检查环境
check_environment() {
    log "检查部署环境..."
    
    # 检查Docker
    if ! command -v docker &> /dev/null; then
        error "Docker未安装"
    fi
    
    # 检查Docker Compose
    if ! command -v docker-compose &> /dev/null; then
        error "Docker Compose未安装"
    fi
    
    # 检查环境文件
    if [ ! -f ".env.${ENV}" ]; then
        error "环境文件 .env.${ENV} 不存在"
    fi
    
    log "环境检查通过"
}

# 备份数据库
backup_database() {
    log "备份数据库..."
    
    # 创建备份目录
    BACKUP_DIR="./backups/$(date +%Y%m%d_%H%M%S)"
    mkdir -p "${BACKUP_DIR}"
    
    # 备份MySQL
    docker-compose -f "${COMPOSE_FILE}" exec db mysqldump -u root -p"${DB_ROOT_PASSWORD}" tieba_prod > "${BACKUP_DIR}/tieba.sql"
    
    # 备份Redis
    docker-compose -f "${COMPOSE_FILE}" exec redis redis-cli --rdb /data/dump.rdb
    docker cp "tieba_redis:/data/dump.rdb" "${BACKUP_DIR}/"
    
    log "数据库备份完成: ${BACKUP_DIR}"
}

# 停止服务
stop_services() {
    log "停止服务..."
    docker-compose -f "${COMPOSE_FILE}" down
}

# 更新代码
update_code() {
    log "更新代码..."
    
    # 拉取最新代码
    git pull origin main
    
    # 检查是否有更新
    if git diff --quiet HEAD@{1} HEAD; then
        log "代码无更新"
        return 1
    fi
    
    log "代码更新完成"
    return 0
}

# 构建镜像
build_images() {
    log "构建Docker镜像..."
    docker-compose -f "${COMPOSE_FILE}" build --no-cache
}

# 启动服务
start_services() {
    log "启动服务..."
    
    # 启动基础服务
    docker-compose -f "${COMPOSE_FILE}" up -d db redis elasticsearch
    
    # 等待数据库就绪
    log "等待数据库就绪..."
    sleep 30
    
    # 启动应用服务
    docker-compose -f "${COMPOSE_FILE}" up -d web celery celery_beat
    
    # 执行数据库迁移
    log "执行数据库迁移..."
    docker-compose -f "${COMPOSE_FILE}" exec web python manage.py migrate
    
    # 收集静态文件
    log "收集静态文件..."
    docker-compose -f "${COMPOSE_FILE}" exec web python manage.py collectstatic --noinput
    
    # 启动Nginx
    docker-compose -f "${COMPOSE_FILE}" up -d nginx
    
    log "服务启动完成"
}

# 健康检查
health_check() {
    log "执行健康检查..."
    
    # 检查Web服务
    if ! curl -f http://localhost/api/health/ > /dev/null 2>&1; then
        error "Web服务健康检查失败"
    fi
    
    # 检查数据库连接
    if ! docker-compose -f "${COMPOSE_FILE}" exec db mysql -u root -p"${DB_ROOT_PASSWORD}" -e "SELECT 1;" > /dev/null 2>&1; then
        error "数据库连接检查失败"
    fi
    
    log "健康检查通过"
}

# 清理旧镜像
cleanup() {
    log "清理旧Docker镜像..."
    docker image prune -f
}

# 主函数
main() {
    log "开始部署百度贴吧项目 (环境: ${ENV})"
    
    # 加载环境变量
    source ".env.${ENV}"
    
    # 执行部署流程
    check_environment
    backup_database
    stop_services
    
    if update_code; then
        build_images
    fi
    
    start_services
    health_check
    cleanup
    
    log "部署完成"
}

# 执行主函数
main "$@"
```

## 4. 运维监控

### 4.1 监控配置

#### 4.1.1 Prometheus配置
```yaml
# prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - "alert_rules.yml"

scrape_configs:
  - job_name: 'django'
    static_configs:
      - targets: ['web:8000']
    metrics_path: '/metrics'

  - job_name: 'nginx'
    static_configs:
      - targets: ['nginx:9113']
    metrics_path: '/metrics'

  - job_name: 'mysql'
    static_configs:
      - targets: ['db:9104']

  - job_name: 'redis'
    static_configs:
      - targets: ['redis:9121']

alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093
```

#### 4.1.2 Grafana仪表板
```json
{
  "dashboard": {
    "title": "百度贴吧监控",
    "panels": [
      {
        "title": "API请求量",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(django_http_requests_total[5m])",
            "legendFormat": "{{method}} {{path}}"
          }
        ]
      },
      {
        "title": "数据库连接数",
        "type": "stat",
        "targets": [
          {
            "expr": "mysql_global_status_threads_connected"
          }
        ]
      }
    ]
  }
}
```

### 4.2 日志管理

#### 4.2.1 ELK日志收集
```yaml
# filebeat.yml
filebeat.inputs:
- type: log
  paths:
    - /var/log/nginx/*.log
  fields:
    service: nginx

- type: log
  paths:
    - /app/logs/*.log
  fields:
    service: django

output.elasticsearch:
  hosts: ["elasticsearch:9200"]
  index: "tieba-logs-%{+yyyy.MM.dd}"
```

#### 4.2.2 日志轮转配置
```bash
# /etc/logrotate.d/tieba
/var/log/nginx/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 nginx nginx
    postrotate
        /usr/bin/kill -USR1 $(cat /var/run/nginx.pid 2>/dev/null) 2>/dev/null || true
    endscript
}
```

## 5. 备份与恢复

### 5.1 数据库备份

#### 5.1.1 自动备份脚本
```bash
#!/bin/bash
# backup.sh

# 备份目录
BACKUP_DIR="/opt/backups/tieba"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p "${BACKUP_DIR}/${DATE}"

# 备份MySQL
mysqldump -h localhost -u root -p"${DB_ROOT_PASSWORD}" --single-transaction --routines --triggers tieba_prod | gzip > "${BACKUP_DIR}/${DATE}/tieba.sql.gz"

# 备份Redis
redis-cli -h localhost -p 6379 -a "${REDIS_PASSWORD}" --rdb "${BACKUP_DIR}/${DATE}/dump.rdb"

# 备份Elasticsearch
curl -X GET "localhost:9200/_snapshot/tieba_backup/snapshot_${DATE}?wait_for_completion=true" -H 'Content-Type: application/json' -d'
{
  "indices": "tieba-*",
  "ignore_unavailable": true,
  "include_global_state": false
}'

# 清理30天前的备份
find "${BACKUP_DIR}" -type d -mtime +30 -exec rm -rf {} \;

# 发送备份完成通知
curl -X POST -H 'Content-type: application/json' --data '{"text":"百度贴吧数据库备份完成: '${DATE}'"}' ${SLACK_WEBHOOK_URL}
```

### 5.2 灾难恢复

#### 5.2.1 恢复流程
```bash
#!/bin/bash
# restore.sh

# 恢复MySQL
gunzip -c backup.sql.gz | mysql -h localhost -u root -p"${DB_ROOT_PASSWORD}" tieba_prod

# 恢复Redis
redis-cli -h localhost -p 6379 -a "${REDIS_PASSWORD}" --flushall
cat dump.rdb | redis-cli -h localhost -p 6379 -a "${REDIS_PASSWORD}" --pipe

# 恢复Elasticsearch
curl -X POST "localhost:9200/_snapshot/tieba_backup/snapshot_latest/_restore" -H 'Content-Type: application/json' -d'
{
  "indices": "tieba-*",
  "ignore_unavailable": true,
  "include_global_state": false
}'
```

## 6. 安全配置

### 6.1 网络安全

#### 6.1.1 防火墙配置
```bash
# 允许必要端口
ufw allow 22    # SSH
ufw allow 80     # HTTP
ufw allow 443    # HTTPS
ufw allow 3306   # MySQL
ufw allow 6379   # Redis
ufw enable
```

#### 6.1.2 SSL证书配置
```bash
# 使用Let's Encrypt获取免费SSL证书
certbot certonly --standalone -d tieba.example.com

# 自动续期
crontab -e
# 添加以下行
0 12 * * * /usr/bin/certbot renew --quiet
```

### 6.2 应用安全

#### 6.2.1 Django安全配置
```python
# settings.py
# 安全配置
SECURE_BROWSER_XSS_FILTER = True
SECURE_CONTENT_TYPE_NOSNIFF = True
SECURE_HSTS_SECONDS = 31536000
SECURE_HSTS_INCLUDE_SUBDOMAINS = True
SECURE_HSTS_PRELOAD = True
SECURE_SSL_REDIRECT = True
SESSION_COOKIE_SECURE = True
CSRF_COOKIE_SECURE = True

# 防止点击劫持
X_FRAME_OPTIONS = 'DENY'

# 内容安全策略
CSP_DEFAULT_SRC = ["'self'"]
CSP_SCRIPT_SRC = ["'self'", "'unsafe-inline'"]
CSP_STYLE_SRC = ["'self'", "'unsafe-inline'"]
```

## 7. 性能优化

### 7.1 数据库优化

#### 7.1.1 MySQL优化配置
```ini
# my.cnf
[mysqld]
# 内存配置
innodb_buffer_pool_size = 4G
innodb_log_file_size = 256M
innodb_log_buffer_size = 64M

# 连接配置
max_connections = 1000
thread_cache_size = 100

# 查询缓存
query_cache_type = 1
query_cache_size = 128M

# 其他优化
innodb_flush_log_at_trx_commit = 2
sync_binlog = 0
```

### 7.2 缓存优化

#### 7.2.1 Redis优化配置
```ini
# redis.conf
maxmemory 2gb
maxmemory-policy allkeys-lru
save 900 1
save 300 10
save 60 10000
```

## 8. 故障排查

### 8.1 常见问题解决

#### 8.1.1 服务无法启动
```bash
# 检查容器状态
docker ps -a

# 查看容器日志
docker logs tieba_web

# 检查端口占用
netstat -tulpn | grep :8000
```

#### 8.1.2 数据库连接问题
```bash
# 检查MySQL服务
systemctl status mysql

# 检查连接数
mysqladmin -u root -p status

# 检查慢查询
mysqldumpslow /var/log/mysql/slow.log
```

本部署运维文档提供了从开发环境到生产环境的完整部署方案，包括容器化部署、监控配置、备份恢复、安全配置等内容，确保百度贴吧项目的稳定运行。